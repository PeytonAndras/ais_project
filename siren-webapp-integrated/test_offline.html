<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIREN Offline Map Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #map { 
            height: 100vh; 
            width: 100vw;
        }
        
        .info-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            z-index: 1000;
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .controls {
            margin-top: 15px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.secondary:hover {
            background: #545b62;
        }
        
        .test-markers {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .ship-marker {
            color: #007bff;
            font-size: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .ship-marker.selected {
            color: #dc3545;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <h3><i class="fas fa-anchor"></i> SIREN Offline Test</h3>
        
        <div id="connection-status" class="status">
            <i class="fas fa-spinner fa-spin"></i> Checking connection...
        </div>
        
        <div class="controls">
            <button class="btn" onclick="toggleConnectionMode()">
                <i class="fas fa-sync"></i> Toggle Mode
            </button>
            <button class="btn secondary" onclick="addTestShips()">
                <i class="fas fa-ship"></i> Add Test Ships
            </button>
            <button class="btn secondary" onclick="clearMarkers()">
                <i class="fas fa-trash"></i> Clear
            </button>
        </div>
        
        <div class="test-markers">
            <div id="marker-count">Markers: 0</div>
            <div id="current-layer">Layer: Loading...</div>
        </div>
        
        <div style="margin-top: 15px; font-size: 11px; color: #666;">
            <strong>Test Instructions:</strong><br>
            ‚Ä¢ Try switching map layers<br>
            ‚Ä¢ Go offline to test cached tiles<br>
            ‚Ä¢ Add test ships to verify markers<br>
            ‚Ä¢ Check console for tile loading info
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let testMarkers = [];
        let currentLayerName = '';
        
        // Test ship positions around Portugal coast
        const testShips = [
            {name: "Atlantic Trader", lat: 39.52, lon: -9.18, course: 45},
            {name: "Fishing Vessel Maria", lat: 39.48, lon: -9.22, course: 180},
            {name: "Cargo Express", lat: 39.60, lon: -9.10, course: 270},
            {name: "Naval Patrol", lat: 39.45, lon: -9.25, course: 90}
        ];
        
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            const isOnline = navigator.onLine;
            
            statusEl.className = `status ${isOnline ? 'online' : 'offline'}`;
            statusEl.innerHTML = `
                <i class="fas fa-${isOnline ? 'wifi' : 'wifi-slash'}"></i>
                ${isOnline ? 'Online Mode' : 'Offline Mode'}
            `;
        }
        
        function createShipIcon(selected = false) {
            return L.divIcon({
                className: `ship-marker ${selected ? 'selected' : ''}`,
                html: '<i class="fas fa-ship"></i>',
                iconSize: [selected ? 28 : 24, selected ? 28 : 24],
                iconAnchor: [selected ? 14 : 12, selected ? 14 : 12]
            });
        }
        
        function addTestShips() {
            clearMarkers();
            
            testShips.forEach((ship, index) => {
                const marker = L.marker([ship.lat, ship.lon], {
                    icon: createShipIcon(index === 0)
                }).addTo(map);
                
                marker.bindPopup(`
                    <div style="text-align: center;">
                        <strong>${ship.name}</strong><br>
                        Position: ${ship.lat.toFixed(4)}, ${ship.lon.toFixed(4)}<br>
                        Course: ${ship.course}¬∞<br>
                        <small>Test vessel for offline mapping</small>
                    </div>
                `);
                
                testMarkers.push(marker);
            });
            
            updateMarkerCount();
            
            // Center map on test ships
            const group = new L.featureGroup(testMarkers);
            map.fitBounds(group.getBounds(), {padding: [20, 20]});
        }
        
        function clearMarkers() {
            testMarkers.forEach(marker => map.removeLayer(marker));
            testMarkers = [];
            updateMarkerCount();
        }
        
        function updateMarkerCount() {
            document.getElementById('marker-count').textContent = `Markers: ${testMarkers.length}`;
        }
        
        function toggleConnectionMode() {
            // Simulate connection toggle for testing
            if (navigator.onLine) {
                // Go "offline"
                Object.defineProperty(navigator, 'onLine', {
                    writable: true,
                    value: false
                });
            } else {
                // Go "online"
                Object.defineProperty(navigator, 'onLine', {
                    writable: true,
                    value: true
                });
            }
            
            updateConnectionStatus();
            window.dispatchEvent(new Event(navigator.onLine ? 'online' : 'offline'));
        }
        
        function initializeMap() {
            console.log('üó∫Ô∏è Initializing SIREN offline test map...');
            
            // Define offline layers
            const offlineLayers = {
                'OpenStreetMap (Offline)': L.tileLayer('tiles/openstreetmap/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap (Offline Cache)',
                    maxZoom: 18,
                    errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjEyOCIgeT0iMTI4IiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIE9mZmxpbmUgVGlsZTwvdGV4dD48L3N2Zz4='
                }),
                'Satellite (Offline)': L.tileLayer('tiles/satellite/{z}/{x}/{y}.png', {
                    attribution: '¬© Satellite (Offline Cache)',
                    maxZoom: 18,
                    errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iIzM0NDAyZCIvPjx0ZXh0IHg9IjEyOCIgeT0iMTI4IiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIE9mZmxpbmUgVGlsZTwvdGV4dD48L3N2Zz4='
                })
            };
            
            // Define online layers
            const onlineLayers = {
                'OpenStreetMap (Online)': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }),
                'Satellite (Online)': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri, DigitalGlobe, GeoEye',
                    maxZoom: 19
                })
            };
            
            // Choose layers based on connection
            const isOnline = navigator.onLine;
            const availableLayers = isOnline ? {...offlineLayers, ...onlineLayers} : offlineLayers;
            
            // Initialize map
            const defaultLayer = offlineLayers['OpenStreetMap (Offline)'];
            currentLayerName = 'OpenStreetMap (Offline)';
            
            map = L.map('map', {
                center: [39.5, -9.2], // Portugal coast
                zoom: 10,
                layers: [defaultLayer]
            });
            
            // Add layer control
            const layerControl = L.control.layers(availableLayers, {}, {
                position: 'topright',
                collapsed: false
            }).addTo(map);
            
            // Add scale control
            L.control.scale({
                position: 'bottomleft',
                imperial: false
            }).addTo(map);
            
            // Listen for layer changes
            map.on('baselayerchange', function(e) {
                currentLayerName = e.name;
                document.getElementById('current-layer').textContent = `Layer: ${e.name}`;
                console.log(`üîÑ Switched to layer: ${e.name}`);
            });
            
            // Listen for tile load events
            map.on('tileloadstart', function(e) {
                console.log(`üì• Loading tile: ${e.url}`);
            });
            
            map.on('tileerror', function(e) {
                console.log(`‚ùå Tile load error: ${e.tile.src}`);
            });
            
            // Update current layer display
            document.getElementById('current-layer').textContent = `Layer: ${currentLayerName}`;
            
            // Listen for connection changes
            window.addEventListener('online', function() {
                console.log('üåê Connection restored');
                updateConnectionStatus();
            });
            
            window.addEventListener('offline', function() {
                console.log('üì° Connection lost');
                updateConnectionStatus();
            });
            
            console.log('‚úÖ Test map initialized successfully');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus();
            initializeMap();
            updateMarkerCount();
            
            console.log('üö¢ SIREN Offline Map Test Ready!');
            console.log('üìã Check the info panel for test controls');
        });
    </script>
</body>
</html>
